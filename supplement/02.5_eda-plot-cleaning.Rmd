---
editor_options: 
  chunk_output_type: console
---

# Visualise data cleaning

```{r}
library(data.table)
library(ggplot2)
library(patchwork)
library(ggspatial)
```

```{r}
# read file names
files <- list.files("data/processed/data_preprocessed",
  full.names = TRUE
)

# raw data
files_raw = list.files(
  "data/processed/data_id",
  full.names = TRUE
)
```

```{r}
for (file in files) {
  # read processed data
  data = fread(file)
  # get tag
  tag = unique(data$TAG_ID)
  treat = unique(data$treat)
  sp = unique(data$sp)
  
  message(
    glue::glue(
      "sp = {sp} tag = {tag} treat = {treat}"
    )
  )
  
  # get raw data
  file_raw = files_raw[grep(tag, files_raw)]
  file_raw = file_raw[grep(treat, file_raw)]
  
  message(
    glue::glue(
      "file-raw = {file_raw}"
    )
  )
  
  data_raw = fread(file_raw)
  data_raw[, time := as.POSIXct(UNIX, tz = "Asia/Jerusalem", origin = "1970-01-01")]
  data_raw[, date := lubridate::date(time)]
  
  # assert correct tag
  assertthat::assert_that(
    tag == unique(data_raw$TAG_ID)
  )
  
  p = ggplot()+
    geom_point(
      data = data_raw,
      aes(x, y),
      size = 0.1,
      col = "grey50"
    )+
    geom_path(
      data = data_raw,
      aes(x, y),
      size = 0.1,
      colour = "grey"
    )+
    geom_path(
      data = data,
      aes(x, y, col = factor(date)),
      size = 0.1
    )+
    geom_point(
      data = data,
      aes(x, y, col = factor(date)),
      size = 0.5,
      show.legend = F
    )+
    scale_colour_viridis_d(
      option = "H",
      na.value = "grey"
    )+
    coord_sf(
      crs = 2039
    )
  
  p = ggplotly(p)
  htmlwidgets::saveWidget(p, 
    file = sprintf("figures/figures_preprocessing/fig_preproc_%s_%s_%s.html", 
                   sp, tag, treat))
}
```

