---
editor_options: 
  chunk_output_type: console
---

```{r}
library(readr)
library(purrr)
library(dplyr)
library(tidyr)

library(ggplot2)
library(colorspace)
library(patchwork)
```

```{r}
# read rrv
rrv = read_csv("data/results/data_daily_rrv.csv")
rrv$date = as.character(rrv$date)
```

## Fit clogit to data

```{r}
# read data
files = list.files(
  "data/processed/data_for_clogit",
  pattern = "csv", full.names = TRUE
)
```

```{r}
# which files
ids = stringr::str_extract(files, "\\d{10}")
dates = stringr::str_extract(files, "\\d{4}-\\d{2}-\\d{2}")
```

```{r}
to_keep = ids %in% rrv$TAG & dates %in% rrv$date
files = files[to_keep]
```

```{r eval=FALSE, include=FALSE}
# read data
data = map(
  files, read_csv
)

# bind and save
data = bind_rows(data)

# step means
data_step_covs = group_by(
  data,
  id, date,
  patch_start,
  patch_end,
  case_,
) %>% 
  summarise(
    across(
      matches(c("ndvi", "vis")),
      mean
    )
  )

# proportion of lc class
data_step_lc = group_by(
  data,
  id, date,
  patch_start,
  patch_end,
  case_,
) %>%
  summarise(
    as.data.frame(table(lc_end))
  )

# convert to percentages
data_step_lc = ungroup(
  data_step_lc
) %>% 
  group_by(
    id, date, patch_start, patch_end, case_
  ) %>% 
  mutate(
    Freq = Freq / sum(Freq)
  )

# pivot wide
data_step_lc = pivot_wider(
  data_step_lc,
  names_from = "lc_end",
  values_from = "Freq", 
  values_fill = 0
)

# link to env attributes
data_step_covs = left_join(
  data_step_covs,
  data_step_lc
)

write_csv(
  data_step_covs,
  file = "data/results/data_ssf_step_covs.csv"
)
```

```{r}
rm(data); gc()
```

## Link with rrv and treatment

```{r}
data_step_covs = mutate(
  data_step_covs,
  date = as.character(date)
)

data_step_covs = left_join(
  data_step_covs,
  rrv,
  by = c("id" = "TAG", "date")
)
```

## Selection within high NDVI values

```{r}
fig_vis_selection =
  ggplot(
    filter(
      data_step_covs,
      between(ndvi_end, 0.4, 0.6),
      !is.na(sp)
    )
  )+
  geom_boxplot(
    aes(
      as.factor(treat), vis_end,
      fill = case_
    )
  )+
  scale_fill_discrete_qualitative(
    # palette = "Blue-Red",
    # l1 = 50,
    rev = T,
    limits = c("TRUE", "FALSE"),
    labels = c("Real patches", "Alternative patches")
  )+
  scale_x_discrete(
    labels = c(
      "Manip.",
      "Moult.",
      "N-moult."
    )
  )+
  facet_grid(
    cols = vars(sp)
  )+
  theme_grey(
    base_family = "Arial",
    base_size = 8
  )+
  theme(
    # strip.background = element_blank(),
    # strip.text = element_text(
    #   face = "italic"
    # ),
    # legend.box.margin = margin(rep(0, 4)),
    # legend.margin = margin(rep(0, 4)),
    # panel.grid.minor = element_blank(),
    # panel.grid.major.x = element_blank(),
    legend.position = "top",
    # legend.key.height = unit(1, "mm"),
    # legend.key.width = unit(5, "mm")
  )+
  labs(
    x = "Wing condition", #(More complete wing →)
    y = "Visibility index at next patch\n(More open →)",
    fill = NULL
  )

ggsave(
  fig_vis_selection,
  filename = "figures/fig_vis_selection_wing.png",
  height = 87,
  width = 87,
  units = "mm"
)
```

```{r}
fig_vis_rrv = 
  ggplot(
    filter(
      data_step_covs,
      between(ndvi_end, 0.4, 0.6),
      !is.na(sp),
      !is.na(rrv_calc),
      !is.na(treat)
    )
  )+
  geom_jitter(
    aes(
      rrv_calc, vis_end,
      colour = case_,
      group = interaction(rrv_calc, case_)
    ),
    shape = 1,
    position = position_dodge(width = 0.5)
  )+
  geom_smooth(
    data = filter(
      data_step_covs,
      between(ndvi_end, 0.4, 0.6),
      !is.na(sp),
      !is.na(rrv_calc),
      !is.na(treat),
      case_
    ),
    aes(
      rrv_calc, vis_end,
      group = treat
    ),
    method = "glm"
  )+
  scale_colour_discrete_qualitative(
    # palette = "Blue-Red",
    # l1 = 50,
    rev = T,
    limits = c("TRUE", "FALSE"),
    labels = c("Real patches", "Alternative patches")
  )+
  scale_x_reverse()+
  facet_grid(
    cols = vars(sp)
  )+
  theme_grey(
    base_family = "Arial",
    base_size = 8
  )+
  theme(
    # strip.background = element_blank(),
    # strip.text = element_text(
    #   face = "italic"
    # ),
    # legend.box.margin = margin(rep(0, 4)),
    # legend.margin = margin(rep(0, 4)),
    # panel.grid.minor = element_blank(),
    # panel.grid.major.x = element_blank(),
    legend.position = "top",
    # legend.key.height = unit(1, "mm"),
    # legend.key.width = unit(5, "mm")
  )+
  labs(
    x = "Estimated RRV (More complete wing →)", #(More complete wing →)
    y = "Visibility index at next patch\n(More open →)",
    col = NULL
  )

ggsave(
  fig_vis_rrv,
  filename = "figures/fig_vis_selection_rrv.png",
  height = 87,
  width = 114,
  units = "mm"
)
```

```{r}

```

