---
editor_options: 
  chunk_output_type: console
---

```{r}
library(readr)
library(dplyr)
library(tidyr)

library(ggplot2)
library(colorspace)
library(patchwork)
```

```{r}
# read in saved data
data_step_covs = read_csv("data/results/data_ssf_step_covs.csv")

# remove cols
data_step_covs = select(
  data_step_covs,
  id,
  date,
  matches(c("x", "y")),
  matches(c("ndvi", "vis")),
  case_, step_id_,
  B, O, R, `T`, W,
  -X22
)

# read rrv
rrv = read_csv("data/results/data_daily_rrv.csv")
rrv$date = as.character(rrv$date)
```

```{r}
data_step_covs = mutate(
  data_step_covs,
  date = as.character(date)
)

data_step_covs = left_join(
  data_step_covs,
  rrv,
  by = c("id" = "TAG", "date")
)
```

### Summarise by case and treatment

```{r}
# filter for high ndvi values
data_sel = filter(
  data_step_covs,
  between(ndvi_end, 0.4, 1)
)

# filter out data without species or rrv
data_sel = filter(
  data_sel,
  !is.na(sp),
  !is.na(treat),
  !is.na(rrv_calc)
)

sdf = filter(
  data_sel
) |> 
  select(
    sp, treat, case_,
    rrv_calc,
    matches(c("vis", "ndvi"))
  )

sdf = sdf |> 
  group_by(
    sp, treat, case_
  ) |> 
  summarise(
    across(
      matches(c("vis", "ndvi", "rrv")), 
      .fns = list(
        mean = function(x) mean(x, na.rm=T),
        sd = function(x) sd(x, na.rm = T)
      )
    ),
    .groups = "keep"
  )|> 
  rename(
    vis_mean = vis_end_mean,
    vis_sd = vis_end_sd,
    ndvi_mean = ndvi_end_mean,
    ndvi_sd = ndvi_end_sd
  ) |> 
  mutate(
    case_ = if_else(case_, "real", "alternate")
  )
```

### Model visibility with RRV

```{r}
# convert sp and treat to factor
data_sel = mutate(
  data_sel,
  across(
    c(sp, treat, id),
    .fns = as.factor
  )
)
```

```{r}
library(mgcv)

mod1 = gam(
  vis_end ~ s(rrv_calc, by = sp, k = 3) +
    s(sp, bs = "re"),
  data = filter(
    data_sel, case_
  )
)

summary(mod1)
gratia::draw(mod1)
```

## Model visibility across RRV

```{r}
# make prediction table
pred_data = crossing(
  sp = as.factor(unique(data_sel$sp)),
  id = "new",
  rrv_calc = seq(0, 20, 0.5)
)

# get prediction
pred = predict(mod1, newdata = pred_data, allow.new.levels = T, se.fit = T)

pred_data$pred = pred$fit
pred_data$se = pred$se.fit

# explore
ggplot(data_sel)+
  # geom_jitter(
  #   aes(
  #     rrv_calc, vis_mean_end,
  #     col = treat
  #   ),
  #   shape = 1
  # )+
  geom_point(
    data = pred_data,
    aes(
      rrv_calc, pred
    )
  )+
  facet_grid(
    ~sp
  )
```

## Plot comparison of real and potential patches visibility

```{r}
fig_vis_selection =
ggplot(sdf)+
  geom_jitter(
    data = filter(
      data_sel,
      !case_
    ),
    aes(
      rrv_calc, vis_end
    ),
    col = "lightgrey",
    shape = 4,
    size = 0.2
  )+
  geom_jitter(
    data = filter(
      data_sel,
      case_
    ),
    aes(
      rrv_calc, vis_end,
      col = treat,
    ),
    shape = 1
  )+
  geom_ribbon(
    data = filter(
      pred_data,
      !(sp %in% c("Passer", "Pycnonotus") & rrv_calc > 17)
    ),
    aes(
      rrv_calc,
      ymin = pred - se,
      ymax = pred + se
    ),
    fill = "transparent",
    col = "grey",
    lty = 1
  )+
  geom_line(
    data = filter(
      pred_data,
      !(sp %in% c("Passer", "Pycnonotus") & rrv_calc > 17)
    ),
    aes(
      rrv_calc, pred
    ),
    col = "indianred"
  )+
  geom_linerange(
    aes(
      x = rrv_calc_mean,
      ymin = vis_mean - vis_sd,
      ymax = vis_mean + vis_sd
    ),
    position = position_nudge(
      x = c(-1, 1)
    )
  )+
  geom_linerange(
    aes(
      x = rrv_calc_mean, y = vis_mean,
      xmin = rrv_calc_mean - rrv_calc_sd,
      xmax = rrv_calc_mean + rrv_calc_sd
    ),
    position = position_nudge(
      x = c(-1, 1)
    )
  )+
  geom_point(
    aes(
      rrv_calc_mean, vis_mean,
      shape = case_,
      fill = treat
    ),
    size = 3,
    position = position_nudge(
      x = c(-1, 1)
    )
  )+
  geom_text(
    data = tibble(
      x = 0,
      y = 0.9,
      l = "NDVI > 0.4"
    ),
    hjust = "inward",
    fontface = "italic",
    aes(x, y, label = l)
  )+
  scale_fill_discrete_sequential(
    palette = "Batlow",
    l1 = 30, l2 = 60,
    breaks = c("NonMoulting", "Moulting", "Manipulated"),
    labels = c("N. Moulting", "Moulting", "Manipulated")
  )+
  scale_colour_discrete_sequential(
    palette = "Batlow",
    l1 = 50, l2 = 50,
    guide = "none"
  )+
  scale_shape_manual(
    values = c(
      "real" = 21, 
      "alternate" = 25
    ),
    limits = c("alternate", "real"),
    # breaks = c("real", "alternate"),
    labels = c("Potential", "Real")
  )+
  facet_grid(
    cols = vars(sp),
    scales = "free_x"
  )+
  theme_test(
    base_size = 10,
    base_family = "Arial"
  )+
  theme(
    legend.position = "top",
    strip.background = element_blank(),
    strip.text = element_text(
      face = "italic"
    )
  )+
  labs(
    x = "RRV (More ragged wing)",
    y = "Visibility at next patch",
    fill = NULL,
    shape = NULL
  )+
  guides(
    fill = guide_legend(
      override.aes = list(
        shape = 22
      )
    ),
    shape = guide_legend(
      override.aes = list(
        size = 3
      )
    )
  )

ggsave(
  fig_vis_selection,
  filename = "figures/fig_03.png",
  height = 87,
  width = 178,
  units = "mm"
)
```

### Compare real and potential patches NDVI

```{r}
fig_ndvi_selection = ggplot(sdf)+
  geom_jitter(
    data = filter(
      data_sel,
      !case_
    ),
    aes(
      rrv_calc, ndvi_end
    ),
    col = "lightgrey",
    shape = 4,
    size = 0.2
  )+
  geom_jitter(
    data = filter(
      data_sel,
      case_
    ),
    aes(
      rrv_calc, ndvi_end,
      col = treat,
    ),
    shape = 1
  )+
  geom_linerange(
    aes(
      x = rrv_calc_mean,
      ymin = ndvi_mean - ndvi_sd,
      ymax = ndvi_mean + ndvi_sd
    ),
    position = position_nudge(
      x = c(-1, 1)
    )
  )+
  geom_linerange(
    aes(
      x = rrv_calc_mean, y = ndvi_mean,
      xmin = rrv_calc_mean - rrv_calc_sd,
      xmax = rrv_calc_mean + rrv_calc_sd
    ),
    position = position_nudge(
      x = c(-1, 1)
    )
  )+
  geom_point(
    aes(
      rrv_calc_mean, ndvi_mean,
      shape = case_,
      fill = treat
    ),
    size = 3,
    position = position_nudge(
      x = c(-1, 1)
    )
  )+
  scale_fill_discrete_sequential(
    palette = "Batlow",
    l1 = 30, l2 = 60,
    breaks = c("NonMoulting", "Moulting", "Manipulated"),
    labels = c("N. Moulting", "Moulting", "Manipulated")
  )+
  scale_colour_discrete_sequential(
    palette = "Batlow",
    l1 = 50, l2 = 50,
    guide = "none"
  )+
  scale_shape_manual(
    values = c(
      "real" = 21, 
      "alternate" = 25
    ),
    limits = c("alternate", "real"),
    # breaks = c("real", "alternate"),
    labels = c("Potential", "Real")
  )+
  facet_grid(
    cols = vars(sp),
    scales = "free_x"
  )+
  theme_test(
    base_size = 10,
    base_family = "Arial"
  )+
  theme(
    legend.position = "top",
    strip.background = element_blank(),
    strip.text = element_text(
      face = "italic"
    )
  )+
  labs(
    x = "RRV (More ragged wing)",
    y = "NDVI at next patch",
    fill = NULL,
    shape = NULL
  )+
  guides(
    fill = guide_legend(
      override.aes = list(
        shape = 22
      )
    ),
    shape = guide_legend(
      override.aes = list(
        size = 3
      )
    )
  )

ggsave(
  fig_ndvi_selection,
  filename = "figures/fig_ndvi_sel_rrv.png",
  height = 87,
  width = 178,
  units = "mm"
)
```

