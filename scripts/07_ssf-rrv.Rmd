---
output: html_document
editor_options: 
  chunk_output_type: console
---

# Compare SSF params with RRV

Here we compare SSF coefficients with RRV scores.

## Load libraries and prepare files

```{r}
# libs for data
library(dplyr)
library(tidyr)
library(purrr)
library(readr)
library(stringr)

# libs for messages
library(glue)

# library for SSF data
library(amt)

# plotting libs
library(ggplot2)
library(colorspace)
```

Load data from saved `Rds` object, and RRV data.

```{r}
# add ssf data
load("data/results/data_fitted_ssfs.Rds")

# load rrv data
rrv <- read_csv("data/results/data_daily_rrv.csv")
```

## SSF parameters

```{r}
# filter for bad fits
ssfs <- filter(
  ssfs,
  !map_lgl(
    ssf, is.null
  )
)

# select track identifiers
ssf_params <- select(
  ssfs,
  -matches("ssf")
)

# select model parameter for ndvi preference
ssf_params <- mutate(
  ssf_params,
  coefs = map(ssfs$ssf, function(l) {
    tryCatch(
      expr = {
        broom::tidy(
          l$model
        )
      },
      error = function(e) {
        return(NULL)
      }
    )
  }),
  shape = map_dbl(ssfs$ssf, function(l) {
    l$sl_$params$shape
  })
)

# unnest
ssf_params <- unnest(ssf_params, cols = coefs)
```

## Link SSF coefficients and RRV

```{r}
# make rrv date as date
rrv <- mutate(
  rrv,
  date = lubridate::date(date)
)

# edit date class to characters
rrv$date = as.character(rrv$date)
ssf_params$date = as.character(ssf_params$date)

# link ssf params and rrv
ssf_params <- left_join(
  ssf_params,
  rrv
)
```

## Correct SL in LC classes

```{r}
# filter coefficients
data <- filter(
  ssf_params,
  treat != "LongPeriod",
  !is.na(estimate)
)

# get sl coefficient for all models
data <- data %>%
  group_by(
    TAG_ID, date, sp, treat
  ) %>%
  mutate(
    sl_coef = estimate[term == "log_sl"]
  )

# get corrected SL for each landcover
data <- ungroup(data)
data <-
  mutate(
    data,
    estimate_corrected = case_when(
      str_detect(term, "sl:") ~ estimate + shape + sl_coef,
      str_detect(term, "log_sl") ~ estimate + shape,
      TRUE ~ estimate
    )
  )
```

## Relative Selection Strengths

```{r}
ggplot(filter(data, abs(estimate_corrected) < 50)) +
  geom_jitter(
    aes(
      rrv_calc, estimate_corrected,
      shape = sp,
      col = p.value <= 0.05,
      alpha = p.value <= 0.05
    ),
    show.legend = T
  ) +
  scale_colour_viridis_d(
    option = "H",
    direction = -1,
    begin = 0.1,
    end = 0.8
  ) +
  scale_alpha_manual(
    values = c(0.5, 1),
    guide = F
  ) +
  scale_y_continuous(
    trans = ggallin::ssqrt_trans
  ) +
  facet_grid(sp ~ term, scales = "free_y") +
  theme(
    legend.position = "top"
  ) +
  labs(
    x = "Calculated RRV",
    y = "Relative Selection Strength",
    shape = "Sp.",
    col = "p < 0.05", alpha = NULL
  )
  ```

## Selection and RRV

```{r}
library()
```

