---
output: html_document
editor_options: 
  chunk_output_type: console
---

# Compare SSF params with RRV

Here we compare SSF coefficients with RRV scores.

## Load libraries and prepare files

```{r}
# libs for data
library(dplyr)
library(tidyr)
library(purrr)
library(readr)

# libs for messages
library(glue)

# library for SSF data
library(amt)

# plotting libs
library(ggplot2)
library(colorspace)
```

Load data from saved `Rds` object, and RRV data.

```{r}
# add ssf data
load("data/results/data_fitted_ssfs.Rds")

# load rrv data
rrv = read_csv("data/results/data_daily_rrv.csv")
```

## SSF parameters

```{r}
# select track identifiers
ssf_params = select(
  ssfs,
  -matches("ssf")
)

# select model parameter for ndvi preference
ssf_params = mutate(
  ssf_params,
  coefs = map(ssfs$ssf, function(l) {
    # convert model to data frame
    broom::tidy(
      l$model
    )
  }),
  shape = map_dbl(ssfs$ssf, function(l) {
    l$sl_$params$shape
  })
)

# unnest
ssf_params = unnest(ssf_params, cols = coefs)
```

## Link SSF coefficients and RRV

```{r}
# make rrv date as date
rrv = mutate(
  rrv,
  date = lubridate::date(date)
)

# link ssf params and rrv
ssf_params = left_join(
  ssf_params,
  rrv
)
```

## Visualise coefficient NDVI and RRV

```{r}
ssf_params = filter(
  ssf_params,
  treat != "LongPeriod"
)

data = ssf_params %>% 
      mutate(rrv_calc = cut(rrv_calc, 
                            breaks = seq(0, 20, 5), 
                            include.lowest = T)
      ) %>% 
      filter(
        !is.na(rrv_calc)#,
        # term == "landcover4"
        )

# plot
ggplot()+
  geom_boxplot(
    data = data,
    aes(
      factor(rrv_calc), estimate
    )
  )+
  # geom_jitter(
  #   data = ssf_params,
  #   aes(
  #     rrv_calc, estimate,
  #     col = p.value <= 0.05
  #   )
  # )+
  # geom_smooth(
  #   data = ssf_params,
  #   aes(
  #     rrv_calc, shape
  #   ),
  #   method = "glm"
  # )+
  # ylim(0.25, 1.5)+
  scale_y_continuous(
    trans=ggallin::ssqrt_trans,
    limits = c(-20, 20)
  )+
  facet_grid(sp~term)+
  theme(
    legend.position = "top"
  )
```

