---
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r}
library(readr)
library(tidyr)
library(dplyr)
library(glue)
library(purrr)

library(amt)
```


```{r}
tracks = read_csv("data/results/data_ssf_step_covs.csv")
rrv = read_csv("data/results/data_daily_rrv.csv")

tracks$date = as.character(tracks$date)
rrv$date = as.character(rrv$date)
```

```{r}
tracks = full_join(
  tracks,
  rrv,
  by = c("id"= "TAG", "date")
)

tracks_rrv = filter(tracks, !is.na(rrv_calc))
tracks_wing = filter(tracks, !is.na(treat))
```

## SSF fitting

```{r}
# nest by rrv calc and sp
tracks_rrv = nest(
  tracks_rrv, 
  data = -matches(c("sp", "rrv_calc", "treat"))
)

# count rows
tracks_rrv = mutate(
  tracks_rrv,
  nrow = map_int(
    data, function(df) nrow(filter(df, !is.na(ndvi_mean_start)))
  )
)

# remove empty data
tracks_rrv = filter(
  tracks_rrv,
  nrow > 10
)
```

```{r}
# specify the model formula
ssf_formula <- "case_ ~ ndvi_mean_end + vis_mean_end + ndvi_mean_end:vis_mean_end + vis_mean_start:vis_mean_end + strata(step_id_)"

# add formula to dataframe
ssfs <- mutate(
  tracks_rrv,
  ssf_formula = ssf_formula
)

# sink output to log
sink(file = "data/log_ssf_fit.log")

ssf_comment <- "Writing SSF log"

# first print date
print(
  glue("
    SSF fit log from {Sys.time()}

    comment: {ssf_comment}

  ")
)

# fit ssfs overwriting the track data
ssfs <- mutate(
  ssfs,
  ssf = imap(data, function(.x, .y) {

    # pass the model fitting through a try catch
    # this allows errors to be logged and prevents the process from
    # breaking when there is an error
    tryCatch(

      # the model fitting expression to evaluate
      expr = {

        # print some information about the data -- which row, which id, treatment
        print(
          glue("sp = {ssfs$sp[.y]}; \\
            rrv_calc = {ssfs$rrv_calc[.y]};
            row in dataframe = {.y}
            formula = {ssfs$ssf_formula[.y]}
            start time: {Sys.time()}
           ")
        )

        # this is the SSF fit function from amt
        ssf_fit <-
          .x %>%
          amt::fit_ssf(
            formula = as.formula(ssfs$ssf_formula[.y])
          )

        # print success message to the processing log
        print(
          glue("
            SUCCESS at time: {Sys.time()}
            ---

            ")
        )

        # return the model fit object
        ssf_fit
      },
      error = function(e) {

        # print an error message with information about the data
        print(
          glue("FAILED at time: {Sys.time()}")
        )
        # print the error message itself
        print(e)

        # a trailing blank line
        print(
          glue("
            ---

            ")
        )

        # return null if there is an error
        NULL
      }
    )
  })
)

# end sinking to log
sink()

save(ssfs, file = "data/results/data_fitted_ssfs.Rds")
```

## SSF parameters

```{r}
# filter for bad fits
ssfs <- filter(
  ssfs,
  !map_lgl(
    ssf, is.null
  )
)

# select track identifiers
ssf_params <- select(
  ssfs,
  -matches("ssf")
)

# select model parameter for ndvi preference
ssf_params <- mutate(
  ssf_params,
  coefs = map(ssfs$ssf, function(l) {
    tryCatch(
      expr = {
        broom::tidy(
          l$model
        )
      },
      error = function(e) {
        return(NULL)
      }
    )
  })
  # shape = map_dbl(ssfs$ssf, function(l) {
  #   l$sl_$params$shape
  # })
)

# unnest
ssf_params <- unnest(ssf_params, cols = coefs)

# get exp coefs
ssf_params = mutate(
  ssf_params,
  exp_coef = exp(estimate)
)

rm(ssfs); gc()
```

```{r}
# remove data
ssf_params = select(ssf_params, -data)
```

```{r}
library(ggplot2)
```

```{r}
ggplot(ssf_params)+
  geom_point(
    aes(
      rrv_calc, estimate,
      col = treat
    )
  )+
  scale_y_continuous(
    trans = ggallin::pseudolog10_trans
  )+
  facet_grid(
    term ~ sp
  )
```

