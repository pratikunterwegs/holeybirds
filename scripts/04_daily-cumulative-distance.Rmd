---
editor_options: 
  chunk_output_type: console
---

# Cumulative daily distance in relation to RRV

RRV is a score of how gappy the wing is.

## Load libraries and prepare files

```{r}
# libs for data
library(data.table)
library(lubridate)

# library for atlas data
library(atlastools)

# plotting
library(ggplot2)
library(colorspace)
```

```{r}
# load data from file
data <- fread("data/processed/data_thinned_for_analysis.csv")

rrv = fread("data/results/data_daily_rrv.csv")
```

## Calculate distances and times of day

### Calculate distance

```{r}
# get distances bw points
data <- split(data, by = c("TAG_ID", "sp", "treat", "date"))

# order data by time
data <- lapply(data, setorderv, "time")

# calculate distances
data <- lapply(data, function(df) {
  df[, distance := atl_simple_dist(df)]
  df$distance <- nafill(df$distance, type = "const", fill = 0)
  df
})
```

### Calculate time of day

```{r}
# get interval since start of day --- will be nighttime
data <- lapply(data, function(df) {
  df[, posix_time := as.POSIXct(time, origin = "1970-01-01", 
                                tz = "Asia/Jerusalem")]
  # difference in minutes between time and start of day
  df[, min_day := as.numeric(
     hour(posix_time) * 60 + minute(posix_time)
  )]
  # round min_day to 10 mins
  df[, min_day := plyr::round_any(min_day, 10)]
})
```

## Cumulative daily distance

### Calculate cumulative daily distance

```{r}
# summarise distance in 10 min intervals and then cuml distance
data_summary = lapply(data, function(df) {
    # sum distance in interval
    df = df[, list(distance = sum(distance)), 
        by = c("min_day", "date", "sp", "treat", "TAG_ID")]
    df[, cuml_distance := cumsum(distance)]
    df
})

# bind the rows
data_summary <- rbindlist(data_summary)

# set levels
data_summary$treat = factor(data_summary$treat,
                            levels = c("NonMoulting", "Moulting", "Manipulated"))

# save to file
fwrite(data_summary, file = "data/results/data_daily_cumulative_distance.csv")
```

### Connect with RRV

```{r}
# join on date, species, id, and treatment
# first fix date
data_summary$date = as.POSIXct(data_summary$date)

data_summary = merge(
  data_summary,
  rrv,
  by = c("sp", "treat", "TAG_ID", "date")
)
```


### Plot cumulative daily distance over time

```{r plot_cuml_dist}
# make labeller
label_condition = c(
  "NonMoulting" = "Non moulting",
  "Moulting" = "Moulting",
  "Manipulated" = "Manipulated"
)

ggplot(data_summary[sp != "Hirundo" & treat != "LongPeriod"]) +
  geom_path(
    aes(
      min_day, cuml_distance,
      group = interaction(TAG_ID, date),
      col = rrv_calc
    ),
    # show.legend = F,
    alpha = 0.8
  )+
  scale_colour_binned_sequential(
    palette = "Batlow",
    breaks = c(0, 2, 5, 10, 15)
  )+
  scale_y_sqrt(
    labels = function(x) { 
      scales::comma(x, accuracy = 1, scale = 0.001, suffix = "km")
    },
    breaks = c(1, 5, 10, 20) * 1e3
  )+
  scale_x_continuous(
    labels = function(x) { sprintf("%ihr", as.integer(x / 60)) },
    breaks = c(5, 10, 15, 20) * 60
  )+
  coord_cartesian(
    expand = F,
    xlim = c(5 * 60, NA),
    ylim = c(0, 15e3)
  )+
  theme_test()+
  theme(
    axis.text.x = element_text(
      size = 8
    ),
    legend.key.width = unit(2, units = "mm")
  )+
  facet_grid(
    ~sp,# ~ treat, 
    labeller = labeller(
      treat = label_condition
    )
  )+
  labs(
    colour = "Est. RRV",
    x = "Hour of day",
    y = "Cumulattive distance (km)"
  )

# save plot to file
ggsave(
  filename = "figures/fig_cumulative_daily_distance.png",
  height = 3, width = 8
)
```

## Total daily distance

### Calculate total daily distance

```{r tot_daily_dist}
# sum distances per day
data_dist_summary = rbindlist(data)
data_dist_summary = data_dist_summary[, list(
  total_distance = sum(distance)
), by = c("TAG_ID", "sp", "treat", "date")]

# check for as many rows as there are combinations of the identifiers
assertthat::assert_that(
  nrow(data_dist_summary) == length(data),
  msg = "incorrect number of total daily distances"
)

# set factor order
data_dist_summary$treat = factor(data_dist_summary$treat,
                            levels = c("NonMoulting", "Moulting", "Manipulated"))

# save to file
fwrite(data_dist_summary, file = "data/results/data_daily_total_distance.csv")
```

### Plot total daily distance

```{r}
# remove swallows and long term sparrows
data_dist_summary = data_dist_summary[sp != "Hirundo" & treat != "LongPeriod"]
data_dist_summary$date = as.POSIXct(data_dist_summary$date)

# link with rrv
data_dist_summary = merge(
  data_dist_summary,
  rrv
)

# make plot
ggplot(data_dist_summary)+
  geom_jitter(
    aes(rrv_calc, total_distance,
        col = rrv_calc),
    shape = 1,
    stroke = 1
  )+
  scale_colour_binned_sequential(
    palette = "Batlow",
    breaks = c(0, 2, 5, 10, 15)
  )+
  scale_y_sqrt(
    labels = function(x) { 
      scales::comma(x, accuracy = 1, scale = 0.001, suffix = "km")
    },
    breaks = c(1, 5, 10, 20) * 1e3
  )+
  # scale_x_discrete(
  #   labels = c("Non moulting", "Moulting", "Manipulated")
  # )+
  theme_test()+
  theme(
    axis.text.x = element_text(
      size = 8
    ),
    legend.key.width = unit(2, units = "mm")
  )+
  facet_grid(~sp)+
  labs(
    x = "Calculated RRV",
    y = "Total distance (km)",
    colour = "Est. RRV"
  )

# save as figure
ggsave(
  filename = "figures/fig_total_distance.png",
  height = 3, width = 6
)
```

## Daily Net Squared Displacement (NSD)

### Calcualte NSD

NSD is the squared (spatial) distance between all locations $(x_i, y_i, t_i)$ and the first location $(x_1, y_1, t_1)$.

```{r}
source("R/net_square_displacement.R")
# working on data list object
data = lapply(data, function(df) {
  
  # using custom functions from the directory R/
  df[, nsd := get_nsd(data = df)]
})

# summarise NSD over min_day
data_nsd_summary = lapply(data, function(df) {
  df[, list(
    nsd_mean = mean(nsd),
    nsd_sd = sd(nsd)
  ), by = c("TAG_ID", "sp", "treat", "date", "min_day")]
})

# bind list and write to file
data_nsd_summary = rbindlist(data_nsd_summary)

# set factor order
data_nsd_summary$treat = factor(data_nsd_summary$treat,
                            levels = c("NonMoulting", "Moulting", "Manipulated"))

fwrite(data_nsd_summary, file = "data/results/data_daily_nsd.csv")
```

### Summarise for Species and Treatment

Here we take each day and individual as a replicate.

```{r}
# round min day to 30 minutes
data_nsd_summary[, min_day_30 := plyr::round_any(min_day, 30)]

# link to rrv
data_nsd_summary$date = as.POSIXct(data_nsd_summary$date)

data_nsd_summary = merge(
  data_nsd_summary,
  rrv
)

data_nsd_concise = data_nsd_summary[, list(
  nsd_mean = mean(nsd_mean),
  nsd_median = median(nsd_mean),
  nsd_sd = sd(nsd_sd)
), by = c("sp", "treat", "min_day_30")]
```


### Plot daily NSD

```{r}
# exclude swallows and LT sparrows
ggplot()+
  geom_path(
    data = data_nsd_summary[sp != "Hirundo" & treat != "LongPeriod"],
    aes(
      min_day, sqrt(nsd_mean),
      colour = rrv_calc,
      group = interaction(sp, date, treat, TAG_ID)
    ),
    alpha = 0.6
  )+
  # geom_line(
  #   data = data_nsd_concise[sp != "Hirundo" & treat != "LongPeriod"],
  #   aes(
  #     x = min_day_30,
  #     y = sqrt(nsd_median),
  #     group = interaction(sp, treat)
  #   ),
  #   shape = 0
  # )+
  # scale_colour_discrete_qualitative(
  #   palette = "Harmonic",
  #   l1 = 50, h1 = 50, c1 = 30,
  #   rev = T
  # )+
  scale_colour_binned_sequential(
    palette = "Batlow",
    breaks = c(0, 2, 5, 10, 15)
  )+
  scale_x_continuous(
    labels = function(x) { sprintf("%ihr", as.integer(x / 60)) },
    breaks = c(1, 6, 12, 18, 23) * 60
  )+
  scale_y_sqrt(
    labels = function(x) { 
      scales::comma(x, accuracy = 1, scale = 0.001, suffix = "km")
    },
    breaks = c(1, 2, 4) * 1e3
  )+
  theme_test()+
  theme(
    axis.text.x = element_text(
      size = 8
    ),
    legend.key.width = unit(2, units = "mm")
  )+
  facet_grid(
    ~ sp, 
    labeller = labeller(
      treat = label_condition
    ),
    scales = "free_y"
  )+
  labs(
    x = "Hour of day",
    y = "Net displacement (km)",
    colour = "Est. RRV"
  )

# save as figure
ggsave(
  filename = "figures/fig_net_displacement.png",
  height = 3, width = 6
)
```

