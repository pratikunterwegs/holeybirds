---
editor_options: 
  chunk_output_type: console
---

# Vegetation, visibility, and land use in the study area

## Load libraries

```{r}
# libs for data
library(data.table)
library(glue)

library(sf)
library(terra)
# to plot rasters
library(stars)

library(ggplot2)
library(colorspace)
```

## Load data

```{r}
# load rasters using terra
ndvi = rast("data/rasters/raster_hula_ndvi_2039.tif")
vis = rast("data/rasters/raster_hula_visibility.tif")

# load land use as sf
landcover = st_read("data/spatial/hula_lc_vector")
landcover = st_crop(landcover, vis)

# crop ndvi by vis
ndvi = crop(ndvi, vis)
```

## NDVI across the landscape

```{r}
ndvi = st_as_stars(ndvi)
```

```{r}
fig_ndvi =
  ggplot()+
  geom_stars(
    data = ndvi,
    # downsample = 5
  )+
  coord_sf(
    crs = 2039,
    expand = F
  )+
  scale_x_continuous(
    breaks = seq(35.58, 35.64, length.out = 3)
  )+
  ggspatial::annotation_scale()+
  scico::scale_fill_scico(
    direction = -1,
    palette = "bamako",
    limits = c(0.05, 0.7),
    breaks = c(0.05, seq(0.3, 0.7, 0.2)),
    name = "NDVI",
    na.value = "aliceblue"
  )+
  theme_test()+
  theme(
    legend.position = "bottom",
    legend.key.height = unit(2, "mm"),
    legend.title = element_text(
      vjust = 1
    ),
    axis.title = element_blank(),
    axis.text = element_text(
      size = 8
    ),
    axis.text.y = element_text(
      angle = 90, hjust = 0.5
    )
  )

# save figure
ggsave(
  fig_ndvi,
  filename = "figures/fig_spm_02.png",
  height = 130, width = 80, units = "mm"
)
```

## Visibility across the landscape

```{r}
vis = st_as_stars(vis)
```

```{r}
fig_vis =
  ggplot()+
  geom_stars(
    data = vis,
    downsample = 9
  )+
  coord_sf(
    crs = 2039,
    expand = F
  )+
  scale_x_continuous(
    breaks = seq(35.58, 35.64, length.out = 3)
  )+
  ggspatial::annotation_scale()+
  scico::scale_fill_scico(
    direction = 1,
    palette = "lapaz",
    limits = c(0, 1),
    breaks = seq(0., 1, 0.2),
    name = "Visibility index"
  )+
  theme_test()+
  theme(
    legend.position = "bottom",
    legend.key.height = unit(2, "mm"),
    legend.title = element_text(
      vjust = 1
    ),
    axis.title = element_blank(),
    axis.text = element_text(
      size = 8
    ),
    axis.text.y = element_text(
      angle = 90, hjust = 0.5
    )
  )

# save figure
ggsave(
  fig_vis,
  filename = "figures/fig_spm_03.png",
  height = 130, width = 80, units = "mm"
)
```

## Plot landcover

```{r}
landcover = mutate(
  landcover,
  class = if_else(
    Name %in% c("C", "W"),
    "W", Name
  )
)
```


```{r}
fig_landcover = 
  ggplot(landcover)+
  geom_sf(
    aes(
      fill = class
    ),
    col = "transparent"
  )+
  scico::scale_fill_scico_d(
    palette = "hawaii",
    direction = 1,
    labels = c(
      "B" = "Settlements",
      "O" = "Open areas",
      "R" = "Reedbeds",
      "T" = "Trees",
      "W" = "Water"
    ),
    name = NULL
  )+
  coord_sf(
    crs = 2039,
    expand = F
  )+
  scale_x_continuous(
    breaks = seq(35.58, 35.64, length.out = 3)
  )+
  theme_test()+
  theme(
    legend.position = "bottom",
    legend.key.height = unit(2, "mm"),
    legend.key.width = unit(2, "mm"),
    legend.title = element_text(
      vjust = 1
    ),
    legend.text = element_text(
      size = 6
    ),
    panel.background = element_rect(
      fill = "grey99"
    ),
    axis.title = element_blank(),
    axis.text = element_text(
      size = 8
    ),
    axis.text.y = element_text(
      angle = 90, hjust = 0.5
    )
  )

# save figure
ggsave(
  fig_landcover,
  filename = "figures/fig_spm_04.png",
  height = 130, width = 80, units = "mm"
)
```

